<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>NYC Secure Remote - Fixed</title>
    <style>
        body { font-family: sans-serif; display: flex; justify-content: center; padding: 40px; background: #0f172a; color: #f8fafc; }
        .container { background: #1e293b; padding: 30px; border-radius: 16px; width: 450px; border: 1px solid #334155; }
        .lock-notice { background: #451a03; color: #fbbf24; padding: 15px; border-radius: 8px; font-size: 14px; margin-bottom: 20px; border: 1px solid #78350f; text-align: center; font-weight: bold; }
        input[type="password"] { width: 100%; box-sizing: border-box; padding: 12px; border-radius: 8px; border: 1px solid #334155; background: #0f172a; color: white; margin-bottom: 15px; }
        .btn-group { display: flex; gap: 12px; margin-bottom: 20px; }
        button { flex: 1; padding: 14px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; }
        #scanBtn { background: #3b82f6; color: white; }
        #sendBtn { background: #22c55e; color: white; }
        button:disabled { background: #334155; color: #64748b; cursor: not-allowed; }
        #log { background: #000; color: #4ade80; font-family: monospace; font-size: 12px; padding: 15px; border-radius: 8px; height: 160px; overflow-y: auto; border: 1px solid #334155; }
    </style>
</head>
<body>

<div class="container">
    <h2 style="color:#3b82f6;">NYC Verified Remote</h2>
    <div class="lock-notice" id="lockNotice">Initializing Security...</div>
    <input type="password" id="passInput" placeholder="Security Password" disabled>

    <div class="btn-group">
        <button id="scanBtn" disabled>1. PAIR DEVICE</button>
        <button id="sendBtn" disabled>2. SEND COMMAND</button>
    </div>
    <div id="log">Fetching bypass-safe headers...<br></div>
</div>

<script>
    let bleDevice = null, bleServer = null;
    let config = { unlock_date: null, password_hash: null };
    let nycNetworkTime = null;

    // Use GitHub API instead of Raw URL for better CORS support
    const GITHUB_API_URL = "https://api.github.com";
    const TIME_API = "https://worldtimeapi.org";

    const log = (msg) => { 
        document.getElementById('log').innerHTML += `> ${msg}<br>`; 
        document.getElementById('log').scrollTop = document.getElementById('log').scrollHeight; 
    };

    async function init() {
        try {
            // 1. Fetch Config via GitHub API (Base64 decoded)
            const res = await fetch(GITHUB_API_URL);
            const data = await res.json();
            const decoded = atob(data.content); // GitHub API returns base64
            config = JSON.parse(decoded);
            log("Security configuration loaded via GitHub API.");

            // 2. Fetch Time with fallback
            const timeRes = await fetch(TIME_API);
            const timeData = await timeRes.json();
            nycNetworkTime = new Date(timeData.datetime);
            log(`NYC Time Verified: ${nycNetworkTime.toLocaleTimeString()}`);

            document.getElementById('scanBtn').disabled = false;
            document.getElementById('passInput').disabled = false;
            updateLockUI();

        } catch (e) {
            log(`CORS/Fetch Error: ${e.message}`);
            document.getElementById('lockNotice').innerText = "Network Error - Verify GitHub Repository is Public";
        }
    }

    function updateLockUI() {
        const unlockAt = new Date(config.unlock_date);
        const notice = document.getElementById('lockNotice');
        if (nycNetworkTime >= unlockAt) {
            notice.innerText = "ðŸ”“ UNLOCKED";
            notice.style.background = "#064e3b"; notice.style.color = "#4ade80";
        } else {
            notice.innerText = "ðŸ”’ Locked until: " + unlockAt.toLocaleString('en-US', {timeZone: 'America/New_York'});
        }
    }

    async function hashString(str) {
        const data = new TextEncoder().encode(str);
        const hash = await crypto.subtle.digest('SHA-256', data);
        return Array.from(new Uint8Array(hash)).map(b => b.toString(16).padStart(2, '0')).join('');
    }

    document.getElementById('scanBtn').addEventListener('click', async () => {
        try {
            bleDevice = await navigator.bluetooth.requestDevice({ acceptAllDevices: true, optionalServices: [0x8ac0] });
            bleServer = await bleDevice.gatt.connect();
            document.getElementById('sendBtn').disabled = false;
            log("Connected to BLE Unit.");
        } catch (e) { log(e.message); }
    });

    document.getElementById('sendBtn').addEventListener('click', async () => {
        const userHash = await hashString(document.getElementById('passInput').value);
        if (userHash !== config.password_hash) { log("!! WRONG PASSWORD !!"); return; }
        if (nycNetworkTime < new Date(config.unlock_date)) { log("!! STILL LOCKED !!"); return; }

        try {
            const service = await bleServer.getPrimaryService(0x8ac0);
            const char = await service.getCharacteristic(0x8ac1);
            await char.writeValue(new Uint8Array([0xAA, 0x01, 0x01, 0x00]));
            log("SUCCESS: Command Transmitted.");
        } catch (e) { log(e.message); }
    });

    init();
</script>
</body>
</html>
